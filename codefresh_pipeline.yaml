version: '1.0'
steps:
  Ballerina_Package:
    title: Build Ballerina Hello Service
    image: rpbo/ballerina
    fail_fast: true
    commands:
    - cd hello-world-service
    - ballerina build hello_world_service.bal
  build_Image:
    title: Build image
    type: build
    image_name: kasunindrasiri/ballerina-codefresh-hello
    working_directory: ./hello-world-service/kubernetes/docker/
    tag: '${{CF_BRANCH_TAG_NORMALIZED}}'
    dockerfile: Dockerfile
  unit_test:
    title: Testerina Tests.
    image: rpbo/ballerina
    commands:
    - ballerina init
    - ballerina test hello-world-service
  deploy_to_k8s:
    title: Deploy to GKE Cluster
    type: deploy
    kind: kubernetes
    cluster: ${{CLUSTER}}
    namespace: ${{NAMESPACE}}
    service: test-service
    when:
      branch:
        only:
         - master