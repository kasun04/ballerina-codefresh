version: '1.0'
steps:
  Ballerina_Package:
    title: Build Ballerina Hello Service
    image: rpbo/ballerina
    fail_fast: true
    commands:
    - echo $0
    - whoami
    - ls -al
    - cd hello-world-service
    - ls
    - ballerina build hello_world_service.bal
  build_Image:
    title: Build image
    type: build
    image_name: kasunindrasiri/ballerina-codefresh-hello
    working_directory: ./hello-world-service/kubernetes/docker/
    tag: '${{CF_BRANCH_TAG_NORMALIZED}}'
    dockerfile: Dockerfile
  deploy:
    title: Kubernetes deploy step
    image: codefresh/cli:latest
    commands:
      - ls ${{CF_VOLUME_PATH}}/ballerina-codefresh/hello-world-service/kubernetes/
      - cat ${{CF_VOLUME_PATH}}/ballerina-codefresh/hello-world-service/kubernetes/hello_world_service_deployment.yaml
      - cat ${{CF_VOLUME_PATH}}/ballerina-codefresh/hello-world-service/kubernetes/hello_world_service_svc.yaml
  deploy_to_k8s:
    title: Deploy to K8s Cluster
    type: deploy
    kind: kubernetes
    cluster: ${{CLUSTER}}
    namespace: ${{NAMESPACE}}
    service: test-service
    file_path: ./hello-world-service/kubernetes/hello_world_service_deployment.yaml
    when:
      branch:
        only:
          - master


  YamlDeploy:
    title: Apply YAMLs
    image: 'codefresh/cf-deploy-kubernetes'
    environment:
      - CHART_NAME=none
      - RELEASE_NAME=none
      - KUBE_CONTEXT=${{CLUSTER}}
      - NAMESPACE=${{NAMESPACE}}
    commands:
      - kubectl apply -f ${{CF_VOLUME_PATH}}/ballerina-codefresh/hello-world-service/kubernetes/.
